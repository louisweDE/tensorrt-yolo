# FROM https://github.com/ceccocats/tkDNN/issues/221#issuecomment-824648044

ARG BASE_IMAGE=louiswe/deepstream-zed:0.1

FROM ${BASE_IMAGE}

RUN apt-get update \
    && export DEBIAN_FRONTEND=noninteractive \
    && apt-get -y install --no-install-recommends \
    build-essential cmake git ninja-build \
    libgtk-3-dev python3-dev python3-numpy \
    ca-certificates file \
    libeigen3-dev libyaml-cpp-dev libssl-dev

# CMAKE
RUN echo "install cmake"
RUN apt install -y software-properties-common && \
    wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | sudo apt-key add - && \
    apt-add-repository 'deb https://apt.kitware.com/ubuntu/ bionic main' && \
    apt-get update && \
    apt-get install -y cmake

# Clean up
RUN apt-get autoremove -y \
    && apt-get clean -y \
    && rm -rf /var/lib/apt/lists/*

# OPENCV
# https://docs.opencv.org/master/d2/de6/tutorial_py_setup_in_ubuntu.html
WORKDIR /usr/local/src
ARG CVTAG=4.5.0
RUN git clone --depth 1 --branch ${CVTAG} https://github.com/opencv/opencv.git \
    && git clone --depth 1 --branch ${CVTAG} https://github.com/opencv/opencv_contrib.git \
    && mkdir opencv_build

#WORKDIR /usr/local/src/opencv_build
#COPY ./opencv3/OpenCV-*-aarch64.sh /tmp/OpenCV-*-aarch64.sh
#RUN /tmp/OpenCV-*-aarch64.sh --skip-license --prefix=/usr/local \
#    && rm /tmp/OpenCV-*-aarch64.sh

# TKDNN
WORKDIR /usr/local/src
ARG TTAG=tensorrt8
RUN git clone --depth 1 --branch ${TTAG} https://github.com/ceccocats/tkDNN.git \
    && mkdir tkdnn_build

#WORKDIR /usr/local/src/tkdnn_build
#RUN cmake \
#    -G Ninja \
#    -D CMAKE_INSTALL_PREFIX=/usr/local/tkdnn \
#    /usr/local/src/tkdnn
#RUN ninja -j$(nproc) \
#    && ninja install -j$(nproc)

RUN mkdir /usr/local/opencv

COPY ./demo.cpp /tmp/demo.cpp 
#file destionation /usr/local/src/tkDNN/demo/demo/demo.cpp
COPY ./demoConfig.yml /tmp/demoConfig.yml 
#file destination /usr/local/src/tkDNN/build/demoConfig.yml
COPY ./Makefile Makefile

#RUN wget https://stereolabs.sfo2.cdn.digitaloceanspaces.com/zedsdk/3.7/ZED_SDK_Tegra_L4T32.7_v3.7.1.run
#RUN chmod +x ZED_SDK_Tegra_L4T32.7_v3.7.1.run && ./ZED_SDK_Tegra_L4T32.7_v3.7.1.run -- silent
